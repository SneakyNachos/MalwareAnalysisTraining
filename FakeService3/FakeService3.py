import os
import sys
import win32serviceutil
import win32service
import win32event
import win32api
import win32ui
import win32con
import win32api
import servicemanager
import socket


#python FakeService3.py install
class AppServerSvc (win32serviceutil.ServiceFramework):
    #FakeService3.py  binpath= "C:\Python27\Python.exe" --startup=auto install
    #_svc_name_ = "Windows Telemetry"
    #_svc_display_name_ = "Windows Telemetry"
    _svc_name_ = "Test Service"
    _svc_display_name_ = "Test Service"
    _svc_description_ = "Service for active telemetry and modfications to the telemetry."

    def __init__(self,args):
        win32serviceutil.ServiceFramework.__init__(self,args)
        self.hWaitStop = win32event.CreateEvent(None,0,0,None)
        

    def SvcStop(self):
        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
        win32event.SetEvent(self.hWaitStop)

    def SvcDoRun(self):
        servicemanager.LogMsg(servicemanager.EVENTLOG_INFORMATION_TYPE,
                              servicemanager.PYS_SERVICE_STARTED,
                              (self._svc_name_,''))
        self.main()

    def snapshot(location):
      
        hwin = win32gui.GetDesktopWindow()
        width = win32api.GetSystemMetrics(win32con.SM_CXVIRTUALSCREEN)
        height = win32api.GetSystemMetrics(win32con.SM_CYVIRTUALSCREEN)
        left = win32api.GetSystemMetrics(win32con.SM_XVIRTUALSCREEN)
        top = win32api.GetSystemMetrics(win32con.SM_YVIRTUALSCREEN)
        hwindc = win32gui.GetWindowDC(hwin)
        srcdc = win32ui.CreateDCFromHandle(hwindc)
        memdc = srcdc.CreateCompatibleDC()
        bmp = win32ui.CreateBitmap()
        bmp.CreateCompatibleBitmap(srcdc, width, height)
        memdc.SelectObject(bmp)
        memdc.BitBlt((0, 0), (width, height), srcdc, (left, top), win32con.SRCCOPY)
        bmp.SaveBitmapFile(memdc, location)

    def setupHTTPServer():
        import SimpleHTTPServer
        import SocketServer

        PORT = 8000

        Handler = SimpleHTTPServer.SimpleHTTPRequestHandler

        httpd = SocketServer.TCPServer(("", PORT), Handler)

        httpd.serve_forever()
        return "Servicing at port %s"%port
        pass

    def main(self):
        #Code begins here
        HOST = "127.0.0.1"
        PORT = 44444
        commands = {
            "setupHTTPServer":setupHTTPSever,
            
            }
        def help():
            ret = ""
            ret = ret +  ("Options:\n")
            for command in commands.keys():
                ret = ret + command+"\n"
            return ret



        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            s.bind((HOST,PORT))
            s.listen()
            conn, addr = s.accept()
            with conn:
                while True:
                    data = conn.recv(1024).replace("\n","").replace("\t","")
                    if not data:
                        break
                    
                    output = command.get(data, help)()
                    conn.sendline(output)
                    

        pass

if __name__ == '__main__':
    win32serviceutil.HandleCommandLine(AppServerSvc)